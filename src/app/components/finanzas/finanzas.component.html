<div class="finz">
  <!-- HEADER -->
  <header class="finz__header">FINANZAS</header>

  <!-- KPIs -->
  <section class="kpis">
    <div class="kpi">
      <label>Total de Ingresos</label>
      <div class="kinput">Q {{ totIngresos | number:'1.2-2' }}</div>
    </div>
    <div class="kpi">
      <label>Total de Egresos</label>
      <div class="kinput">Q {{ totEgresos | number:'1.2-2' }}</div>
    </div>
    <div class="kpi">
      <label>Saldo</label>
      <div class="kinput">Q {{ totSaldo | number:'1.2-2' }}</div>
    </div>
  </section>

          <button class="toolbar-btn" type="button" *ngIf="isPastor" (click)="openDiezmos()" aria-label="Abrir diezmos">
          Diezmos
        </button>
  <!-- TABS -->
<mat-tab-group class="finz-tabs" [(selectedIndex)]="tabIndex">
    <!-- MOVIMIENTOS GENERALES -->
    <mat-tab label="Movimientos generales">
      <div class="mg-wrap">
        <!-- Toolbar simplificada -->
        <div class="toolbar">
          <div class="left">
            <div class="search">
              <mat-icon>search</mat-icon>
              <input [formControl]="searchGen" placeholder="Buscar por tesorería o categoría" />
            </div>
          </div>

          <div class="right">
            <!-- Selector de Mes y Año único -->
            <mat-form-field appearance="outline" class="month-field">
              <mat-label>Mes y Año</mat-label>

              <!-- Input visible -->
              <input class="month-display-input" [value]="displayMonth" aria-label="Mes y año seleccionado"
                placeholder="MM/AAAA" readonly (click)="pickerMes.open()" />

              <!-- Botón para abrir el calendario -->
              <button mat-icon-button matSuffix type="button" (click)="pickerMes.open()"
                aria-label="Abrir selector de mes">
                <mat-icon>event</mat-icon>
              </button>

              <!-- Input oculto al que se ancla el mat-datepicker -->
              <input matInput [matDatepicker]="pickerMes" [formControl]="monthCtrl" [max]="maxMonth"
                class="visually-hidden-input" tabindex="-1" aria-hidden="true" />

              <!-- Calendario de selección de mes -->
              <mat-datepicker #pickerMes startView="multi-year" (monthSelected)="chosenMonthHandler($event, pickerMes)">
              </mat-datepicker>
            </mat-form-field>

            <!-- Botón de descarga -->
            <button class="btn btn--excel" type="button" (click)="downloadReporte()" [disabled]="!canDownload"
              matTooltip="Genera el PDF del mes seleccionado" aria-label="Descargar reporte PDF">
              <mat-icon aria-hidden="true">download</mat-icon>
              <span>Descargar Reporte</span>
            </button>

          </div>
        </div>

        <!-- Tabla -->
        <div class="mg-table-container" *ngIf="(movimientosGenerales?.length || 0) > 0; else mgEmpty">
          <table class="mg-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Tesorería</th>
                <th>Categoría</th>
                <th>Tipo</th>
                <th>Cantidad</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let r of movimientosGenerales; let i = index; trackBy: trackByMg">
                <td>{{ i + 1 }}</td>
                <td>{{ r.treasury }}</td>
                <td>{{ r.category }}</td>
                <td>
                  <span class="badge" [ngClass]="r.type === 'Ingreso' ? 'badge-ingreso' : 'badge-egreso'">
                    {{ r.type }}
                  </span>
                </td>
                <td>{{ r.amount | currency:'GTQ':'symbol':'1.2-2' }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Estado vacío -->
        <ng-template #mgEmpty>
          <div class="empty-state">
            <mat-icon>inbox</mat-icon>
            <div>No hay categorías marcadas como <strong>Finanzas Generales</strong></div>
          </div>
        </ng-template>
      </div>
    </mat-tab>

    <!-- TESORERÍAS -->
    <mat-tab label="Tesorerías">
      <div class="treas-wrap">
        <div class="treas-header">
          <h3 class="title">Tesorerías</h3>
        </div>
        <button class="toolbar-btn" type="button" (click)="openAddTesoreria()" aria-label="Agregar tesorería">
           Agregar Tesorería
        </button>
        <!-- Grid de tarjetas -->
        <div class="treas-grid" *ngIf="(treasuries?.length || 0) > 0; else emptyTreas">
          <div class="treas-card" *ngFor="let t of treasuries; trackBy: trackByTreas" (click)="openTreasury(t)"
            tabindex="0" role="button" (keyup.enter)="openTreasury(t)">
            <div class="treas-card-header">
              <div class="treas-card-icon">
                <mat-icon>account_balance_wallet</mat-icon>
              </div>
              <h4 class="treas-card-title">{{ t.name }}</h4>
            </div>
            <p class="treas-card-hint">Click para ver detalles</p>
          </div>
        </div>

        <!-- Estado vacío tesorerías -->
        <ng-template #emptyTreas>
          <div class="empty-state">
            <mat-icon>list_alt</mat-icon>
            <div>No hay tesorerías para mostrar.</div>
          </div>
        </ng-template>
      </div>
    </mat-tab>
  </mat-tab-group>
  <div class="footer">
    <button mat-stroked-button color="primary" (click)="back()">Regresar</button>
  </div>
</div>